<%- include("../../views/partials/user/header") %>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<style>
:root {
    --primary: #1A1A1A;
    --secondary: #8A7B61;
    --accent: #D4AF37;
    --light: #F9F9F9;
    --dark: #1A1A1A;
    --error: #B12704;
    --success: #4A6D51;
    --text-primary: #1A1A1A;
    --text-secondary: #666666;
    --border-color: #E0E0E0;
}

/* General Styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    background-color: var(--light);
    color: var(--text-primary);
    line-height: 1.5;
    letter-spacing: 0.5px;
}

h1, h2, h3, h4, h5 {
    font-weight: 400;
    letter-spacing: 1px;
}

/* Payment Container */
.payment-container {
    max-width: 1280px;
    margin: 0 auto;
    padding: 3rem;
    display: grid;
    grid-template-columns: 1.8fr 1fr;
    gap: 3rem;
}

.payment-section {
    padding-right: 2rem;
}

/* Payment Title */
.payment-title {
    font-size: 2rem;
    font-weight: 400;
    margin-bottom: 2.5rem;
    color: var(--text-primary);
    text-transform: uppercase;
    position: relative;
    padding-bottom: 1rem;
}

.payment-title::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    width: 50px;
    height: 2px;
    background-color: var(--accent);
}

/* Payment Methods */
.payment-methods {
    background: white;
    border: 1px solid var(--border-color);
    padding: 1.5rem;
}

.payment-option {
    display: flex;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all 0.3s ease;
}

.payment-option:hover {
    background-color: rgba(138, 123, 97, 0.05);
}

.payment-option:last-child {
    border-bottom: none;
}

.payment-icon {
    margin-right: 1.5rem;
    color: var(--text-secondary);
    font-size: 1.2rem;
}

.payment-label {
    font-weight: 500;
    color: var(--text-primary);
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 0.9rem;
}

/* Cash on Delivery Section */
.cod-section {
    padding: 2rem 1.5rem;
    background: #F9F9F9;
    border-top: 1px solid var(--border-color);
}

.cod-info {
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
    font-size: 0.9rem;
    letter-spacing: 0.5px;
}

/* Pay Button */
.pay-button {
    background: var(--primary);
    color: white;
    border: none;
    padding: 1.2rem;
    width: 100%;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    letter-spacing: 2px;
    text-transform: uppercase;
}

.pay-button:hover {
    background: var(--secondary);
}

/* Divider */
.divider {
    text-align: center;
    position: relative;
    margin: 2rem 0;
    color: var(--text-secondary);
    font-family: 'Playfair Display', serif;
}

.divider::before,
.divider::after {
    content: "";
    position: absolute;
    top: 50%;
    width: 45%;
    height: 1px;
    background: var(--border-color);
}

.divider::before {
    left: 0;
}

.divider::after {
    right: 0;
}

/* Save Offer Section */
.save-offer {
    background: white;
    border: 1px solid var(--border-color);
    padding: 1.5rem;
    text-align: center;
    margin: 1.5rem 0;
    font-weight: 400;
    letter-spacing: 0.5px;
    color: var(--text-secondary);
}

.save-offer div {
    margin-top: 1rem;
    color: var(--secondary);
    font-weight: 600;
}

/* Order Summary */
.order-summary {
    background: white;
    padding: 2rem;
    border: 1px solid var(--border-color);
}

.order-summary h4 {
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 1.5rem;
    font-size: 1rem;
    color: var(--text-primary);
}

.order-summary h5 {
    font-size: 0.9rem;
    letter-spacing: 2px;
    margin: 2rem 0 1.5rem;
    color: var(--text-primary);
    position: relative;
    padding-bottom: 0.75rem;
}

.order-summary h5::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    width: 30px;
    height: 1px;
    background-color: var(--accent);
}

.delivery-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    background: #F9F9F9;
    margin-bottom: 1.5rem;
    border-left: 3px solid var(--secondary);
}

.delivery-tag {
    background: var(--secondary);
    color: white;
    padding: 0.4rem 0.75rem;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.price-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1rem;
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.price-total {
    color: var(--text-primary);
    font-weight: 600;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-color);
    font-size: 1rem;
}

.price-discount {
    color: var(--success);
}

/* Trust Badges */
.trust-badges {
    display: flex;
    justify-content: space-around;
    margin-top: 3rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-color);
}

.trust-badge {
    text-align: center;
    font-size: 0.7rem;
    color: var(--text-secondary);
    letter-spacing: 1px;
    text-transform: uppercase;
}

/* Checkout Header */
.checkout-header {
    background: white;
    padding: 3rem 1.5rem;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 2rem;
}

.progress-container {
    max-width: 800px;
    margin: 0 auto;
    position: relative;
    padding: 0 1rem;
}

.progress-bar {
    position: absolute;
    top: 50%;
    left: 0;
    transform: translateY(-50%);
    height: 1px;
    width: 100%;
    background: var(--border-color);
    z-index: 1;
}

.progress-bar-fill {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: var(--secondary);
    transition: width 0.3s ease;
    width: 75%; /* Adjust based on current step */
}

.steps-container {
    position: relative;
    display: flex;
    justify-content: space-between;
    z-index: 2;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
}

.step-circle {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: white;
    border: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
    transition: all 0.3s ease;
    font-family: 'Montserrat', sans-serif;
}

.step.active .step-circle {
    border-color: var(--secondary);
    color: var(--secondary);
}

.step.completed .step-circle {
    background: var(--secondary);
    border-color: var(--secondary);
    color: white;
}

.step-label {
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--text-secondary);
    letter-spacing: 1px;
    text-transform: uppercase;
}

.step.active .step-label,
.step.completed .step-label {
    color: var(--secondary);
}

/* Modal Base Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    overflow: auto;
}

.modal-content {
    background-color: #fff;
    margin: 15% auto;
    width: 100%;
    max-width: 420px;
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
    from {transform: translateY(-30px); opacity: 0;}
    to {transform: translateY(0); opacity: 1;}
}

/* Modal Header */
.modal-header {
    padding: 24px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    font-size: 1.2rem;
    font-weight: 400;
    color: var(--text-primary);
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.close-modal {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0;
}

.close-modal:hover {
    color: var(--primary);
}

/* Modal Body */
.modal-body {
    padding: 2rem;
}

/* Wallet Info */
.wallet-info > div {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border-color);
}

.wallet-info > div:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.wallet-balance .label,
.payment-amount .label,
.balance-after .label {
    font-size: 0.9rem;
    color: var(--text-secondary);
    letter-spacing: 0.5px;
}

.wallet-balance .amount,
.payment-amount .amount {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
}

.balance-after .amount {
    font-size: 1rem;
    font-weight: 600;
    color: var(--success);
}

/* Confirm Button */
.confirm-payment-btn {
    width: 100%;
    background-color: var(--primary);
    color: white;
    border: none;
    padding: 1rem;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-top: 1.5rem;
}

.confirm-payment-btn:hover {
    background-color: var(--secondary);
}

/* Low Balance Warning */
.low-balance-warning {
    color: var(--error);
    font-size: 0.8rem;
    margin-top: 1rem;
    display: none;
    letter-spacing: 0.5px;
}

/* Responsive Design */
@media (max-width: 1024px) {
    .payment-container {
        padding: 2rem;
        gap: 2rem;
    }
}

@media (max-width: 768px) {
    .payment-container {
        grid-template-columns: 1fr;
        padding: 1.5rem;
    }

    .payment-section {
        padding-right: 0;
    }

    .payment-title {
        font-size: 1.5rem;
    }

    .step-circle {
        width: 32px;
        height: 32px;
    }

    .step-label {
        font-size: 0.7rem;
    }
    
    .checkout-header {
        padding: 2rem 1rem;
    }
}

@media (max-width: 480px) {
    .modal-content {
        margin: 0;
        max-width: none;
        height: 100%;
    }
    
    .payment-container {
        padding: 1rem;
    }
    
    .payment-methods,
    .order-summary {
        padding: 1rem;
    }
}
</style>
    <!-- header section -->
    <div class="checkout-header">
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-bar-fill"></div>
            </div>
            <div class="steps-container">
                <% 
                const steps = [
                    { id: 1, label: 'Cart', status: 'completed' },
                    { id: 2, label: 'Shipping', status: 'completed' },
                    { id: 3, label: 'Payment', status: 'active' },
                    { id: 4, label: 'Confirmation', status: 'pending' }
                ];
                %>
                <% steps.forEach(step => { %>
                    <div class="step <%= step.status %>">
                        <div class="step-circle">
                            <% if (step.status === 'completed') { %>
                                âœ“
                            <% } else { %>
                                <%= step.id %>
                            <% } %>
                        </div>
                        <span class="step-label"><%= step.label %></span>
                    </div>
                <% }); %>
            </div>
        </div>
    </div>
    <!-- header section end -->
    <div class="payment-container">
        <div class="payment-section">
            <h1 class="payment-title">Choose Your Payment Method</h1>
            
            <div class="payment-methods">
                <% 
                const paymentMethods = [
                    { id: 'upi', icon: 'ðŸ“±', label: 'Online' },
                    { id: 'wallet', icon: 'ðŸ’³', label: 'Wallet' },
                    { id: 'Cash on Delivery', icon: 'ðŸ’µ', label: 'Cash On Delivery', active: true }
                ];
                %>

                <% paymentMethods.forEach(method => { %>
                    <label class="payment-option <%= method.active ? 'active' : '' %>">
                        <input 
                            type="radio" 
                            name="payment" 
                            value="<%= method.id %>" 
                            <%= method.active ? 'checked' : '' %>
                            style="margin-right: 1rem;"
                        >
                        <span class="payment-icon"><%= method.icon %></span>
                        <span class="payment-label"><%= method.label %></span>
                    </label>
                <% }); %>

                <div class="cod-section">
                    <p class="cod-info">
                        Additional cash collection charges of â‚¹ <%= cashCollectionCharge %> is applicable on this order.
                    </p>
                     <!-- Hidden Payment Amount for JavaScript -->
                    <p id="paymentAmount" style="display: none;"><%= total.toFixed(2) %></p>
                    <button class="pay-button text-white" id="pay-btn">PAY â‚¹<%= total.toFixed(2) %></button>
                </div>

                <div class="divider">OR</div>

                <div class="save-offer">
                    Pay via **UPI, Wallet, or Card** and save handling charges
                    <div style="color: var(--gray-700); font-weight: 600; margin-top: 0.5rem;">
                        Pay now and save â‚¹ <%= cashCollectionCharge %>
                    </div>
                </div>
            </div>
        </div>

        <div class="summary-section">
            <div class="order-summary">
                <div class="delivery-header">
                    <span>Delivering order to <%= customerName %></span>
                    <span class="delivery-tag"><%= deliveryType %></span>
                </div>

                <div class="items-section">
                    <h4 style="margin-bottom: 1rem;">Items (<%= itemCount %>)</h4>
                    <% item.forEach(item => { %>
                        <div class="price-row">
                            <span><%= item.name %> (Qty: <%= item.quantity %>)</span>
                            <span>â‚¹<%= item.totalPrice.toFixed(2) %></span>
                         </div>
                    <% }); %>
                </div>
                

                <h5 style="margin: 1.5rem 0 1rem;">PRICE SUMMARY</h5>
                <div class="price-row">
                    <span>Total MRP (Incl. of taxes)</span>
                    <span>â‚¹<%= totalMRP.toFixed(2) %></span>
                </div>
                <%if(offerPrice>0){%>
                <div class="price-row">
                    <span>Coupon discount</span>
                    <span class="price-discount" style="color: red;">-â‚¹<%=offerPrice%></span>
                </div>
                <%}%>
                <div class="price-row">
                    <span>Delivery Fee</span>
                    <span class="price-discount">â‚¹<%=delivery%></span>
                </div>
                <div class="price-row price-total">
                    <span>Total</span>
                    <span> â‚¹<%= total.toFixed(2) %> </span> 
                </div>

                <div class="trust-badges">
                    <div class="trust-badge">
                        âœ“<br>100% SECURE
                    </div>
                    <div class="trust-badge">
                        â†º<br>EASY RETURNS & REFUNDS
                    </div>
                    <div class="trust-badge">
                        â˜…<br>100% GENUINE
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- wallet modal -->
        <div id="walletModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Pay with Wallet</h2>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="wallet-info">
                        <div class="wallet-balance">
                            <span class="label">Available Balance</span>
                            <span class="amount">â‚¹<span id="walletBalance"> <%= walletBalance.toFixed(2) %> </span></span>
                        </div>
                        <div class="payment-amount">
                            <span class="label">Payment Amount</span>
                            <span class="amount">â‚¹<span id="paymentAmount"> <%= total.toFixed(2) %> </span></span>
                        </div>
                        <div class="balance-after">
                            <span class="label">Balance After Payment</span>
                            <span class="amount">â‚¹<span id="balanceAfter"> <%= balanceAfterPayment.toFixed(2) %> </span></span>
                        </div>
                    </div>
                    <button id="confirmWalletPayment" class="confirm-payment-btn">
                        Confirm Payment
                    </button>
                </div>
            </div>
        </div>

<script>

        document.getElementById("pay-btn").addEventListener("click", async function () {
        
            const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
            const selectedAddressId = "<%= selectedAddressId %>"; 
        
            if (paymentMethod === "upi") {
                try {
                    const response = await fetch("/createOrder", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ amount: '<%= total %>', currency: "INR" }),
                    });
        
                    const data = await response.json();
                    if (!data.success) throw new Error("Failed to create order");
        
                    const options = {
        
                        key: "<%=razorpayKeyId%>",
                        amount: data.order.amount,
                        currency: data.order.currency,
                        order_id: data.order.id,
                        name: "Trendy Threads",
                        description: "Test Transaction",
                        handler: async function (response) {
                            Swal.fire({
                                title: "Payment Successful!",
                                text: "Payment ID: " + response.razorpay_payment_id,
                                icon: "success",
                                confirmButtonColor: "#28a745",
                                confirmButtonText: "OK",
                            }).then(async () => {
                                const orderResponse = await fetch('/orderPlaced', {
                                    method: 'POST',
                                    headers: { 'Content-type': 'application/json' },
                                    body: JSON.stringify({ paymentMethod, addressId: selectedAddressId })
                                });
        
                                const result = await orderResponse.json();
        
                                if (result.success) {
                                    window.location.href = '/orderConformed';
                                } else {
                                    Swal.fire({
                                        title: "Error while saving the order!",
                                        text: result.message || 'Error happened!',
                                        icon: "error",
                                        confirmButtonColor: "#dc3545",
                                        confirmButtonText: "Try Again",
                                    });
                                }
                            });
                        },
                        prefill: {
                            email: "test@example.com",
                            contact: "9999999999",
                        },
                        theme: { color: "#3399cc" },
                        modal: {
                            ondismiss: async function () {
        
                                const amountInRupees = options.amount / 100;
        
                                const paymentFailResponse = await fetch('/orderPlaced', {
                                    method: 'POST',
                                    headers: { 'Content-type': 'application/json' },
                                    body: JSON.stringify({ paymentMethod, addressId: selectedAddressId, snum: 'payment-fail' })
                                });
        
                                const result = await paymentFailResponse.json() 
        
                                if (result.success) {
                                    window.location.href = `/payment-failure?orderId=${data.order.id}&paymentMethod="upi"&addressId=${selectedAddressId}`;
                                    return;
                                }
                                
                            }
                        }
                    };
        
                    const rzp = new Razorpay(options);
                    rzp.open();
        
                } catch (error) {
                    Swal.fire({
                        title: "Payment Failed!",
                        text: error.message,
                        icon: "error",
                        confirmButtonColor: "#dc3545",
                        confirmButtonText: "Try Again",
                    }).then(() => {
        
                       console.log('selected address id: ', selectedAddressId);  
                       window.location.href = `/payment-failure?orderId=${data.order.id}&paymentMethod=RAZORPAY&addressId=${selectedAddressId}`;
        
                    });
                }
            } else if (paymentMethod === 'wallet') {
        
                const modal = document.getElementById('walletModal');
                modal.style.display = 'block';
                
                document.querySelector('.close-modal').onclick = function() {
                    modal.style.display = 'none';
                };
        
                window.onclick = function(event) {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                };
        
                document.getElementById('confirmWalletPayment').onclick = async function() {
        
                    console.log('Processing wallet payment...');
            
                    this.innerHTML = 'Processing...';
                    this.disabled = true;
        
                    setTimeout(() => {
        
                        modal.style.display = 'none';
        
                    }, 2000);
        
                    const paymentAmount = '<%= total %>'
        
                    const response = await fetch('/payWithWallet', {
        
                        method: 'POST',
                        headers: {
                            'Content-type': 'application/json'
                        },
                        body: JSON.stringify({ paymentAmount })
                    })
        
                    const result = await response.json()
        
                    if (result.success) {
        
                        const walletResponse = await fetch('/orderPlaced', {
        
                            method: 'POST',
                            headers: { 'Content-type': 'application/json' },
                            body: JSON.stringify({ paymentMethod, addressId: selectedAddressId })
        
                        });
        
        
                        const walletResult = await walletResponse.json()
        
                        if (walletResult.success) {
                            Swal.fire({
                                title: "Payment Successful!",
                                text: "Your payment has been completed using your wallet.",
                                icon: "success",
                                confirmButtonText: "OK"
                            }).then(() => {
                                window.location.href = '/orderConformed';
                            });
                            return;
                        }
        
        
                        Swal.fire({
                            title: "Error while saving the order!",
                            text: walletResult.message || 'Error happened!',
                            icon: "error",
                            confirmButtonColor: "#dc3545",
                            confirmButtonText: "Try Again",
                        });
        
                        return;
                    }
        
                    Swal.fire({
                        title: "Payment Failed!",
                        text: result.message,
                        icon: "error",
                        confirmButtonText: "Try Again"
                    });
        
                };
              
            } else {
        
                const paymentAmount = document.getElementById('paymentAmount').textContent.trim();
        
                console.log('payment amount on cash on delevery: ', paymentAmount);
        
                if (paymentAmount >= 1000) {
                    
                    Swal.fire({
                        icon: 'warning',
                        title: 'COD Not Available',
                        text: 'Cash on Delivery is not available for orders above â‚¹1000.',
                        confirmButtonText: 'OK'
                    });
                    
                    return;
                }
        
                Swal.fire({
                    title: "Cash on Delivery Selected!",
                    text: "Your order will be placed with COD.",
                    icon: "info",
                    confirmButtonColor: "#007bff",
                    confirmButtonText: "OK",
                }).then(async () => {
                    const response = await fetch('/orderPlaced', {
                        method: 'POST',
                        headers: { 'Content-type': 'application/json' },
                        body: JSON.stringify({ paymentMethod, addressId: selectedAddressId })
                    });
        
                    const result = await response.json();
        
                    if (result.success) {
                        window.location.href = '/orderConformed';
                    } else {
                        Swal.fire({
                            title: "Error while saving the order!",
                            text: result.message || 'Error happened!',
                            icon: "error",
                            confirmButtonColor: "#dc3545",
                            confirmButtonText: "Try Again",
                        });
                    }
                });
            }
        });
        
</script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<%- include("../../views/partials/user/footer") %>